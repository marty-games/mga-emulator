<!-- Ported by Unknown -->
<!-- Optimized by Martin_MMC -->
<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>Grand Theft Auto: Vice City</title>
    <base href="https://cdn.jsdelivr.net/gh/web-ports/vice-city@796678be4ed26a13c1256be98781ca9b90beb981/">
    <meta charset="utf-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    >

    <title>Grand Theft Auto: Vice City</title>
    <link rel="stylesheet" href="style.css">
</head>

<body
    data-is-touch="0"
    data-state-car="0"
    data-state-car-gun="0"
    data-state-gun="0"
    data-state-bike="0"
    data-state-menu="1"
    data-state-cutscene="0"
    data-state-mobring="0"
    data-state-job="0"
    data-state-disable-controls="0"
    data-state-panzer="0"
    data-state-car-with-weapon="0"
    data-state-hunter="0"
    data-state-scope-mode="0"
    data-state-scope-gun="0"
>
    <!-- Loading Text -->
    <div
        id="loading-text"
        style="
            color: white;
            font-size: 48px;
            font-family: cursive;
            text-align: center;
            margin-top: 20px;
        "
    >
        LOADING...
    </div>

    <!-- Wasted Screen -->
    <div class="wasted-container" hidden></div>

    <!-- Intro / Loader -->
    <div class="intro-container" hidden>
        <div class="loader-container">
            <div class="progress-bar-container" id="spinner">
                <div class="progress-bar-fill"></div>
            </div>

            <div id="status">Downloading...</div>

            <div>
                <progress id="progress"></progress>
            </div>
        </div>
    </div>

    <!-- Original Game File Input -->
    <input type="file" id="original-game-file" hidden>

    <!-- Game Canvas -->
    <canvas
        class="emscripten"
        id="canvas"
        oncontextmenu="event.preventDefault()"
    ></canvas>

    <!-- Touch Controls -->
    <div class="touch-controls-wrapper">
        <div id="move"></div>
        <div id="look"></div>

        <div class="touch-control radio"></div>
        <div class="touch-control weapon"></div>
        <div class="touch-control menu"></div>
        <div class="touch-control fist"></div>
        <div class="touch-control drift"></div>
        <div class="touch-control run"></div>
        <div class="touch-control car getIn"></div>
        <div class="touch-control left"></div>
        <div class="touch-control right"></div>
        <div class="touch-control jump"></div>
        <div class="touch-control car getOut"></div>
        <div class="touch-control camera"></div>
        <div class="touch-control mobile"></div>
        <div class="touch-control job"></div>
        <div class="touch-control horn"></div>
        <div class="touch-control fireRight"></div>
        <div class="touch-control fireLeft"></div>
    </div>

    <!-- Main Script -->
    <script>
        const loadingText = document.querySelector("#loading-text");
        let loadedBytes = 0;

        const DB_NAME = "gameFilesDB";
        const STORE_NAME = "files";

        // Open or create IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);

                request.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };

                request.onsuccess = e => resolve(e.target.result);
                request.onerror = e => reject(e.target.error);
            });
        }

        // Save file to IndexedDB
        async function saveFile(name, buffer) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, "readwrite");
                const store = tx.objectStore(STORE_NAME);

                store.put(buffer, name);

                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e.target.error);
            });
        }

        // Get file from IndexedDB
        async function getFile(name) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, "readonly");
                const store = tx.objectStore(STORE_NAME);
                const request = store.get(name);

                request.onsuccess = e => resolve(e.target.result);
                request.onerror = e => reject(e.target.error);
            });
        }

        // Fetch with progress + caching
        async function fetchWithCache(name, url) {
            const cached = await getFile(name);
            if (cached) return cached;

            const response = await fetch(url);
            const reader = response.body.getReader();

            let chunks = [];
            let received = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                received += value.length;
                loadedBytes += value.length;
                chunks.push(value);

                const mbDone = (loadedBytes / (1024 * 1024)).toFixed(2);
                const mbTotal = "633.45";

                loadingText.textContent = `LOADING... ${mbDone} MB / ${mbTotal} MB`;
            }

            const fullBuffer = new Uint8Array(received);
            let offset = 0;

            for (const chunk of chunks) {
                fullBuffer.set(chunk, offset);
                offset += chunk.length;
            }

            await saveFile(name, fullBuffer.buffer);
            return fullBuffer.buffer;
        }

        // Merge file parts
        async function mergeFiles(fileParts, namePrefix) {
            const buffers = [];
            for (let i = 0; i < fileParts.length; i++) {
                const buffer = await fetchWithCache(
                    `${namePrefix}.part${i + 1}`,
                    fileParts[i]
                );
                buffers.push(buffer);
            }

            const mergedBlob = new Blob(buffers);
            return URL.createObjectURL(mergedBlob);
        }

        // Generate part URLs
        function getParts(file, start, end) {
            const parts = [];
            for (let i = start; i <= end; i++) {
                parts.push(`${file}.part${i}`);
            }
            return parts;
        }

        // Start loading assets
        Promise.all([
            mergeFiles(getParts("index.data", 1, 7), "index.data"),
            mergeFiles(getParts("audio/emotion.adf", 1, 3), "emotion.adf"),
            mergeFiles(getParts("audio/espant.adf", 1, 3), "espant.adf"),
            mergeFiles(getParts("audio/fever.adf", 1, 3), "fever.adf"),
            mergeFiles(getParts("audio/flash.adf", 1, 3), "flash.adf"),
            mergeFiles(getParts("audio/kchat.adf", 1, 3), "kchat.adf"),
            mergeFiles(getParts("audio/vcpr.adf", 1, 2), "vcpr.adf"),
            mergeFiles(getParts("audio/vrock.adf", 1, 4), "vrock.adf"),
            mergeFiles(getParts("audio/wave.adf", 1, 4), "wave.adf"),
            mergeFiles(getParts("audio/wild.adf", 1, 4), "wild.adf")
        ]).then(urls => {
            const [
                indexdataurl,
                EMOTIONadfurl,
                ESPANTadfurl,
                FEVERadfurl,
                FLASHadfurl,
                KCHATadfurl,
                VCPRadfurl,
                VROCKadfurl,
                WAVEadfurl,
                WILDadfurl
            ] = urls;

            // Override fetch
            const originalFetch = window.fetch;
            window.fetch = async function (input, init) {
                let urlString = input instanceof Request ? input.url : String(input);

                if (urlString.toLowerCase().includes("index.data")) input = indexdataurl;
                else if (urlString.toLowerCase().includes("emotion.adf")) input = EMOTIONadfurl;
                else if (urlString.toLowerCase().includes("espant.adf")) input = ESPANTadfurl;
                else if (urlString.toLowerCase().includes("fever.adf")) input = FEVERadfurl;
                else if (urlString.toLowerCase().includes("flash.adf")) input = FLASHadfurl;
                else if (urlString.toLowerCase().includes("kchat.adf")) input = KCHATadfurl;
                else if (urlString.toLowerCase().includes("vcpr.adf")) input = VCPRadfurl;
                else if (urlString.toLowerCase().includes("vrock.adf")) input = VROCKadfurl;
                else if (urlString.toLowerCase().includes("wave.adf")) input = WAVEadfurl;
                else if (urlString.toLowerCase().includes("wild.adf")) input = WILDadfurl;

                return originalFetch(input.toLowerCase(), init);
            };

            // Load game scripts
            ["gamepademulator.js", "idbfs.js", "game.js"].forEach(src => {
                const script = document.createElement("script");
                script.src = src;
                document.body.appendChild(script);
            });

            loadingText.remove();
        });
    </script>
</body>
</html>
